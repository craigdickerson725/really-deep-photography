{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ photo.title }} | Really Deep Photography{% endblock %}

{% block page_header %}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{{ photo.title }}</h1>

    <div class="row">
        <div class="col-md-6">
            <!-- Cloudinary image with optimization -->
            <img src="{{ photo.image.url|cloudinary_optimized }}" class="img-fluid" alt="{{ photo.title }}">
        </div>
        <div class="col-md-6">
            <h4>Description</h4>
            <p>{{ photo.description }}</p>
            <h4>Size</h4>
            <p>{{ photo.size }}</p>
            <h4>Price</h4>
            <p>{{ photo.price_display }}</p>

            <a href="{% url 'gallery' %}" class="btn btn-primary mt-2">Back to Gallery</a>
            <!-- Add an option to add to cart -->
            <form action="{% url 'add_to_cart' photo.id %}" method="POST" class="mt-3" id="add-to-cart-form">
                {% csrf_token %}
                <input type="hidden" name="quantity" value="1" id="quantity-input">
                <!-- Include the redirect_url hidden field -->
                <input type="hidden" name="redirect_url" value="{% url 'photo_detail' photo.id %}">
                <button type="submit" class="btn btn-black">Add to Cart</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal for displaying 'Item added to cart' message -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cartModalLabel">Really Deep Cart</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body bg-black text-white">
        <p>You added an item to your cart.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeModal">Close</button>
      </div>
    </div>
  </div>
</div>

{% block postloadjs %}
{{ block.super }}
{% include 'photos/includes/quantity_input_script.html' %}

<script type="text/javascript">
    // Listen for the form submission and prevent the default action
    document.getElementById('add-to-cart-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Submit the form using AJAX
        $.ajax({
            type: 'POST',
            url: $(this).attr('action'),
            data: $(this).serialize(),
            success: function(response) {
                // Show modal on successful add-to-cart action
                $('#cartModal').modal('show');
            },
            error: function() {
                alert("There was an error adding the item to the cart.");
            }
        });
    });

    // Handle the Close button in the modal to refresh the page
    document.getElementById('closeModal').addEventListener('click', function() {
        // Redirect the page to the same URL to update the cart count
        window.location.reload(); // Refreshes the page and updates the cart count
    });
</script>
{% endblock %}
{% endblock %}
