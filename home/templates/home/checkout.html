{% extends "base.html" %}

{% load crispy_forms_tags %}
{% load static %}

{% block content %}
<div class="container my-5">
    <h2 class="text-center mb-4">Checkout</h2>
    
    <div class="card p-4 shadow-sm bg-dark text-white">
        
        <h5 class="mb-3">Order Summary</h5>
        <ul class="list-group mb-3">
            {% for item in cart_items %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ item.photo.title }} 
                    <span>${{ item.subtotal|floatformat:2 }}</span>
                </li>
            {% endfor %}
            <li class="list-group-item d-flex justify-content-between">
                <strong>Total:</strong>
                <strong>${{ total_amount|floatformat:2 }}</strong>
            </li>
        </ul>
        
        <h5 class="mb-3">Payment Details</h5>
        
        <form id="payment-form" class="form-group" method="post">
            {% csrf_token %}
            {% crispy form %}  <!-- This should include your form fields -->

            <div id="card-element" class="form-control mb-3"></div>
            <div id="card-errors" role="alert" class="text-danger"></div>

            <button id="checkout-button" class="btn btn-primary w-100 mt-3" type="button">
                Proceed to Payment
            </button>
        </form>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripe_publishable_key }}');
    const elements = stripe.elements();
    
    const cardElement = elements.create('card');
    cardElement.mount('#card-element');

    const form = document.getElementById('payment-form');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        // Check if billing_name exists
        const billingNameField = form.billing_name;
        if (!billingNameField) {
            console.error("Billing name field not found!");
            document.getElementById('card-errors').textContent = "Billing name field is required.";
            return; // Exit if field is not found
        }
        
        const { paymentIntent, error } = await stripe.confirmCardPayment('{{ clientSecret }}', {
            payment_method: {
                card: cardElement,
                billing_details: {
                    name: billingNameField.value, // Safely access the field
                },
            },
        });

        if (error) {
            document.getElementById('card-errors').textContent = error.message;
        } else {
            if (paymentIntent.status === 'succeeded') {
                // Payment was successful
                // Redirect to the order confirmation page
                window.location.href = '/order-confirmation/' + paymentIntent.id; // Update as necessary
            }
        }
    });

    document.getElementById('checkout-button').addEventListener('click', () => {
        form.requestSubmit(); // This submits the form and triggers the event listener
    });
</script>
{% endblock %}
