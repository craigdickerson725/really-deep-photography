{% extends "base.html" %}

{% load crispy_forms_tags %}
{% load static %}

{% block content %}
<div class="container my-5">
    <h2 class="text-center mb-4">Checkout</h2>
    
    <div class="card p-4 shadow-sm bg-dark text-white">
        
        <h5 class="mb-3">Order Summary</h5>
        <ul class="list-group mb-3">
            {% for item in cart_items %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ item.photo.title }} 
                    <span>${{ item.subtotal|floatformat:2 }}</span>
                </li>
            {% endfor %}
            <li class="list-group-item d-flex justify-content-between">
                <strong>Total:</strong>
                <strong>${{ total_amount|floatformat:2 }}</strong>
            </li>
        </ul>
        
        <h5 class="mb-3">Payment Details</h5>
        
        <form id="payment-form" class="form-group" method="post">
            {% csrf_token %}  <!-- This includes the CSRF token in your form -->
            {% crispy form %}  <!-- This should include your form fields -->
            
            <div id="card-element" class="form-control mb-3"></div>
            <div id="card-errors" role="alert" class="text-danger"></div>

            <button id="checkout-button" class="btn btn-primary w-100 mt-3" type="button">
                Proceed to Payment
            </button>
        </form>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripe_publishable_key }}');
    const elements = stripe.elements();
    
    const cardElement = elements.create('card');
    cardElement.mount('#card-element');

    const form = document.getElementById('payment-form');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        // Safely access first name and last name
        const firstName = form.querySelector('input[name="first_name"]');
        const lastName = form.querySelector('input[name="last_name"]');

        // Check if firstName and lastName exist
        if (!firstName || !lastName) {
            console.error("First name or last name field not found!");
            document.getElementById('card-errors').textContent = "First name and last name are required.";
            return; // Exit if fields are not found
        }

        const billingName = `${firstName.value} ${lastName.value}`; // Combine first and last name

        // Get CSRF token from the form
        const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

        const response = await fetch('/create-payment-intent/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken, // Include CSRF token
            },
            body: JSON.stringify({ billing_name: billingName }),
        });

        if (!response.ok) {
            console.error("Failed to create payment intent");
            document.getElementById('card-errors').textContent = "Failed to create payment intent.";
            return;
        }

        const { clientSecret } = await response.json();

        const { paymentIntent, error } = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: cardElement,
                billing_details: {
                    name: billingName, // Use combined name
                },
            },
        });

        if (error) {
            document.getElementById('card-errors').textContent = error.message;
        } else {
            if (paymentIntent.status === 'succeeded') {
                // Payment was successful
                // Redirect to the checkout success page
                window.location.href = '/checkout-success/'; // Update as necessary
            }
        }
    });

    document.getElementById('checkout-button').addEventListener('click', () => {
        form.requestSubmit(); // This submits the form and triggers the event listener
    });
</script>
{% endblock %}
